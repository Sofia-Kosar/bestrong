# azure-pipelines.yml
# Branch = master (trunk). PR -> init/validate/plan. master -> init/validate/apply
# Runs on self-hosted agent pool (Windows) and uses AzureCLI@2 with Service Principal (client secret).

trigger:
  branches:
    include:
      - master

pr:
  branches:
    include:
      - master

pool:
  name: bestrong-selfhosted   # <-- твій Agent Pool

variables:
  TF_DIR: 'infra'
  TF_IN_AUTOMATION: 'true'

stages:
- stage: PR_Check
  displayName: "PR - terraform init/validate/plan"
  condition: eq(variables['Build.Reason'], 'PullRequest')
  jobs:
  - job: plan
    displayName: "Terraform Plan (PR)"
    steps:
    - checkout: self

    - task: AzureCLI@2
      displayName: "Terraform plan"
      inputs:
        azureSubscription: 'AZURE-SC-BESTRONG'  # <-- ТВОЯ Azure RM Service Connection name
        scriptType: ps
        scriptLocation: inlineScript
        addSpnToEnvironment: true
        inlineScript: |
          $ErrorActionPreference = "Stop"

          # ARM auth for Terraform (from service connection)
          $env:ARM_CLIENT_ID       = $env:servicePrincipalId
          $env:ARM_CLIENT_SECRET   = $env:servicePrincipalKey
          $env:ARM_TENANT_ID       = $env:tenantId
          $env:ARM_SUBSCRIPTION_ID = (az account show --query id -o tsv)

          Write-Host "TF_VAR_location=$env:TF_VAR_location"
          Write-Host "TF_VAR_container_image=$env:TF_VAR_container_image"
          Write-Host "TF_VAR_sql_admin_password is set: " ($env:TF_VAR_sql_admin_password -ne $null)

          terraform -chdir=$(TF_DIR) init -input=false
          terraform -chdir=$(TF_DIR) validate
          terraform -chdir=$(TF_DIR) plan -input=false
      env:
        TF_VAR_location: $(TF_VAR_location)
        TF_VAR_container_image: $(TF_VAR_container_image)
        TF_VAR_sql_admin_password: $(TF_VAR_sql_admin_password)

- stage: Master_Deploy
  displayName: "master - terraform init/validate/apply"
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/master'))
  jobs:
  - job: apply
    displayName: "Terraform Apply (master)"
    steps:
    - checkout: self

    - task: AzureCLI@2
      displayName: "Terraform apply"
      inputs:
        azureSubscription: 'AZURE-SC-BESTRONG'  # <-- ТВОЯ Azure RM Service Connection name
        scriptType: ps
        scriptLocation: inlineScript
        addSpnToEnvironment: true
        inlineScript: |
          $ErrorActionPreference = "Stop"

          # ARM auth for Terraform (from service connection)
          $env:ARM_CLIENT_ID       = $env:servicePrincipalId
          $env:ARM_CLIENT_SECRET   = $env:servicePrincipalKey
          $env:ARM_TENANT_ID       = $env:tenantId
          $env:ARM_SUBSCRIPTION_ID = (az account show --query id -o tsv)

          Write-Host "TF_VAR_location=$env:TF_VAR_location"
          Write-Host "TF_VAR_container_image=$env:TF_VAR_container_image"
          Write-Host "TF_VAR_sql_admin_password is set: " ($env:TF_VAR_sql_admin_password -ne $null)

          terraform -chdir=$(TF_DIR) init -input=false
          terraform -chdir=$(TF_DIR) validate
          terraform -chdir=$(TF_DIR) apply -input=false -auto-approve
      env:
        TF_VAR_location: $(TF_VAR_location)
        TF_VAR_container_image: $(TF_VAR_container_image)
        TF_VAR_sql_admin_password: $(TF_VAR_sql_admin_password)
